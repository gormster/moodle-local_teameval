define(["jquery","jqueryui","core/str","core/templates","core/ajax","core/notification"],function(a,b,c,d,e,f){"use strict";var g,h,i,j,k,l,m,n,o,p;return{preAddQuestion:function(b){var c=a('<ul class="local-teameval-question-dropdown" />');a.each(i,function(b,d){var e=a("<li />");e.html("<a>"+d.displayname+"</a>"),e.data("type",d.name),c.append(e)}),a(".local-teameval-containerbox").append(c);var d=l.position();c.css("top",d.top+"px"),c.css("right","0px"),b.stopPropagation();var e=this;a(document).one("click",function(b){if(a(b.target).closest(".local-teameval-question-dropdown").length>0){var d=a(b.target).closest("li").data("type");e.addQuestion(d).done(function(a){e.editQuestion(a)})}c.remove()})},addQuestion:function(b,c,d){var e=a('<li class="local-teameval-question" />'),f=a('<div class="question-container" />');e.append(f),a("#local-teameval-questions").append(e),this.addEditingControls(e),e.data("questiontype",b),c&&e.data("questionid",c);var i=a.Deferred();return require(["teamevalquestion_"+b+"/question"],function(a){var b=new a(f,g,h,j,!0,c,d);f.data("question",b),i.resolve(e)}),i.promise()},addEditingControls:function(b){var c=this;d.render("local_teameval/question_actions",{locked:k}).done(function(d){var e=a(d);b.prepend(e),e.find(".edit").click(function(){c.editQuestion(b)}),e.find(".delete").click(function(){c.deleteQuestion(b)}),b.hasClass("editing")&&e.hide()}),d.render("local_teameval/save_cancel_buttons",{}).done(function(d){var e=a(d);e.find(".save").click(function(){c.saveQuestion(b)}),e.find(".cancel").click(function(){void 0===b.data("questionid")?c.deleteQuestion(b):c.showQuestion(b)}),b.append(e),b.hasClass("editing")||e.hide()})},editQuestion:function(a){a.find(".local-teameval-question-actions").hide();var b=a.find(".question-container"),c=b.data("question");c.editingView().done(function(){a.addClass("editing"),a.find(".local-teameval-save-cancel-buttons").show()}).fail(function(){a.find(".local-teameval-question-actions").show()})},saveQuestion:function(a){var b=a.find(".question-container"),c=b.data("question"),d=a.index(".local-teameval-question"),e=c.save(d);e.done(function(b){a.data("questionid",b),this.showQuestion(a)}.bind(this)),e.fail(function(){}.bind(this))},showQuestion:function(a){var b=a.find(".question-container"),c=b.data("question");c.submissionView().done(function(){a.removeClass("editing"),a.find(".local-teameval-save-cancel-buttons").hide(),a.find(".local-teameval-question-actions").show()}).fail(f.exception)},deleteQuestion:function(a){var b=a.find(".question-container");if(void 0===a.data("questionid"))b.removeData("question"),a.remove();else{var c=b.data("question");c["delete"]().done(function(){b.removeData("question"),a.remove()}).fail(f.exception)}},setOrder:function(){var b=a("#local-teameval-questions li").map(function(){return{type:a(this).data("questiontype"),id:a(this).data("questionid")}}).filter(function(){return void 0!==this}).get(),c=e.call([{methodname:"local_teameval_questionnaire_set_order",args:{id:g,order:b}}]);c[0].done(function(){}).fail(f.exception)},addFromTemplate:function(){var a=m.data("template-id");if(a>0){o.prop("disabled",!0);var b=this,c=e.call([{methodname:"local_teameval_add_from_template",args:{from:a,to:g}}]);c[0].done(function(a){b.addQuestions(a),p(),m.val("")}),c[0].fail(f.exception)}},addQuestions:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.addQuestion(c.type,c.questionid,JSON.parse(c.context)).done(function(a){this.showQuestion(a)}.bind(this))}},initialised:function(){return n||(n=a.Deferred()),n.promise()},initialise:function(b){g=b.id,h=b.contextid,j=b.self,k=b.locked,i=b.subplugins,l=a(b.addButton);var c=a(b.templateSearch),d=a(b.templateIO),q=this;a("#local-teameval-questions .local-teameval-question").each(function(){q.addEditingControls(a(this))}),d.find(".template-download").click(function(){window.location.href=b.download}),k||(a("#local-teameval-questions").sortable({handle:".local-teameval-question-actions .move",axis:"y",update:function(){q.setOrder()}}),l.find("a").click(q.preAddQuestion.bind(q)),o=c.find("button"),o.click(q.addFromTemplate.bind(q)),o.prop("disabled",!0),p=b.templatePreviewFunction,m=c.find("input"),m.autocomplete({minLength:2,source:function(a,b){var c=e.call([{methodname:"local_teameval_template_search",args:{id:g,term:a.term}}]);c[0].done(function(a){b(a)}),c[0].fail(f.exception)},focus:function(a,b){return m.val(b.item.title),!1},select:function(a,b){return b.item?(m.val(b.item.title),m.data("template-id",b.item.id),o.prop("disabled",!1),p(b.item)):(o.prop("disabled",!0),p()),!1}}),m.focus(function(){m.val(""),o.prop("disabled",!0),p()}),m.change(function(){o.prop("disabled",!0),p()}),m.autocomplete("instance")._renderItem=b.autocompleteRenderFunction,d.find(".template-upload").click(function(){var a=M.core_filepicker.instances[b.filepickerid];a.options.formcallback=function(a){var c=e.call([{methodname:"local_teameval_upload_template",args:{id:g,itemid:b.filepickeritemid,file:a.file}}]);c[0].done(function(a){q.initialised().done(function(){q.addQuestions(a)})}),c[0].fail(f.exception)},a.show()}),n||(n=a.Deferred()),n.resolve())}}});